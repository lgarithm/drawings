# -*- mode: sh -*-

set -e

g++ -dumpversion

cc='g++ -std=c++0x -I../include'

opts='-O3 -fPIC'

move(){
    for h in `find $1 | grep "\.h"`; do
        cp -v $h build/include | tee -a cp.log
    done
    for c in `find $1 | grep "\.cpp"`; do
        cp -v $c build/src | tee -a cp.log
    done
}

prepare_source(){
    echo -n "" > cp.log
    for m in `ls src/modules`; do
        move src/modules/$m
    done

    sed -f override.sed -ir build/include/*.h
    rm build/include/*.hr
}

gen_object_target(){
    $cc -MM $1
    echo -e "\t$cc $opts -c $1"
    echo
}

gen_dep_objets(){
    for c in `$cc -MM $1 | tr " " "\n" | grep ".h$" | sed 's/.h$/.cpp/g' | sort | uniq`; do
        if [ -f "`basename $c`" ]; then
            echo `basename $c .cpp`.o
        fi
    done
}

gen_out_target(){
    base=`basename $1 .cpp`
    deps=`gen_dep_objets $1 | tr "\n" " "`
    echo $base".out: $deps $1"
    echo -e "\t$cc $opts $deps $1 -o $base.out"
    echo
}

gen_lib_target(){
    objs=`find ../../src/modules | grep .cpp | grep -v test | awk -F "/" '{print $6}' | sed 's/.cpp$/.o/' | tr "\n" " "`
    echo "librey.a: $objs"
    echo -e "\tar rcs librey.a $objs"
    echo
    echo "librey.so: $objs"
    echo -e "\t$cc $opts -shared -o librey.so $objs"
    echo
}

gen_build_makefile(){
    echo "default: all_tests all_libraries all_binaries"
    echo

    echo "all_tests: "`ls *_test.cpp | sed 's/.cpp$/.out/' | tr "\n" " "`
    echo
    echo "all_libraries: librey.a librey.so"
    echo
    echo "all_binaries: "`ls *_main.cpp | sed s'/.cpp/.out/' | tr "\n" " "`
    echo

    echo "# Binaries"
    for m in `ls *_main.cpp`; do
        gen_out_target $m
    done

    echo "# Tests"
    for t in `ls *_test.cpp`; do
        gen_out_target $t
    done

    echo "# Libs"
    gen_lib_target

    echo "# Objects"
    for c in `ls *.cpp`; do
        gen_object_target $c
    done

    echo "# Clean"
    echo "clean:"
    echo -e "\t-rm *.a *.o *.out *.so"
}

gen_makefile(){
    echo "default: core demo"
    echo
    echo "core:"
    echo -e "\tcd build/src && make"
    echo -e "\tcp build/src/*.a build/lib"
    echo -e "\tcp build/src/*.so build/share"
    echo

    echo "check: core"
    for t in `ls build/src/*_test.cpp`; do
        echo -e "\t./build/src/`basename $t .cpp`.out"
    done
    for m in `ls build/src/*_main.cpp`; do
        echo -e "\t./build/src/`basename $m .cpp`.out -t"
    done
    echo

    echo "install: core"
    echo -e "\tmkdir -p $prefix"
    echo -e "\tcp -r build/bin $prefix/"
    echo -e "\tcp -r build/lib $prefix/"
    echo -e "\tcp -r build/include $prefix/"
    echo -e "\tcp -r build/share $prefix/"
    echo

    echo "demo: core"
    echo -e "\tcd src/apps && bash ./configure && make"
    echo

    echo "clean:"
    echo -e "\tcd build && make clean"
}

prepare_dir(){
    mkdir -pv build/src
    mkdir -pv build/bin
    mkdir -pv build/include
    mkdir -pv build/lib
    mkdir -pv build/share
    mkdir -pv output
}

config(){
    echo -e "\x1b[1;32mCreating Dir\x1b[m"
    prepare_dir
    echo -e "\x1b[1;32mCopying Source\x1b[m"
    prepare_source
    echo -e "\x1b[1;32mGenerating Build Makefile\x1b[m"
    cd build/src
    gen_build_makefile > Makefile
    cd ../..
    echo -e "\x1b[1;32mGenerating Makefile\x1b[m"
    gen_makefile > Makefile
    echo -e "\x1b[1;32mDone\x1b[m"
}

main(){
    prefix=$HOME/local/librey
    config
}

main
